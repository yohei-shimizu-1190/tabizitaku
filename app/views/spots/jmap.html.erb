<div class="container pl-5 pr-5">
  <h2> Google Map</h2>
  <p class="text-warning">localhost でアクセス可能にしてあるためデプロイ時注意。詳細はBMのデプロイ時注意とあるページへ</p>
  <p class="text-warning">APIキーをこのディレクトリ内に記載しているため注意！環境変数必要か？</p>
  <div id="map"></div>
  <div id="iw_wrapper">
    <div id="infowindw">
    <%= @spots.each do |spot|%>
      <h5><%= spot.address %></h5>
    <% end %>
    </div>
  </div>
</div>

<style>
#map{
  height: 500px;
}
#infowindw {
  width: 100px;
  padding: 4px;
}
#iw_wrapper {
  display: none;
}
</style>


<script>
  function initMap(latlng) {
    var map = new google.maps.Map(document.getElementById('map'), {
      center: latlng,
      zoom: 9,
      mapTypeId: "hybrid"
    });

    var marker = new google.maps.Marker({
      position: latlng,
      map: map,
      animation: google.maps.Animation.DROP,
      icon: {
        url: "https://maps.google.com/mapfiles/ms/micons/red-dot.png",
      },
    });

      var infoWindow = new google.maps.InfoWindow({
        position: latlng,
        content: document.getElementById('infowindw'),
        pixelOffset: new google.maps.Size( 0, -30 )
      });
      infoWindow.open(map);
  }


  function getLatLng() {
    var geocoder = new google.maps.Geocoder();
    geocoder.geocode({
      <% @spots.each do |spot| %>
        address: "<%= spot.address %>"
      <% end %>
    }, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        for (var i in results) {
          if (results[i].geometry) {
            var latlng = results[i].geometry.location;
            initMap(latlng)
          }
        }
      }
    });
  }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsbAlSkry5YQYYQFHOYpLCtzjvQeqqqUw&callback=getLatLng"
async defer></script>